<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>FNF Chart Editor - Ultimate iOS版</title>
<style>
/* ====== 全体 ====== */
body {
  margin: 0; background: #101010; color: #fff;
  font-family: sans-serif; user-select: none;
}

/* ====== ヘッダー ====== */
header {
  position: sticky; top:0; background: #111; border-bottom: 2px solid #333;
  padding: 8px; display: flex; flex-wrap: wrap; gap: 4px; align-items: center;
}
button,input,select { margin:2px;padding:4px 6px;border-radius:2px;border:1px solid #555;background:#222;color:#fff;font-size:14px; }
button:hover{background:#333}

/* ====== 波形 ====== */
#wave { width: 100%; height:80px; display:block; background:#111; border-bottom:2px solid #555; }

/* ====== タイムライン ====== */
#timeline { height: 20px; background:#222; border-bottom:2px solid #555; }

/* ====== ノーツエリア ====== */
#lanes { display:grid; grid-template-columns:repeat(4,1fr); height:360px; position:relative; background:linear-gradient(to top,#111 0px,#222 20px); background-size:100% 80px; border-top:2px solid #555; border-bottom:2px solid #555; overflow:hidden; }

/* ====== 各レーン ====== */
.lane { border-left:1px solid #333; border-right:1px solid #333; position:relative; }

/* ====== ノーツ ====== */
.note { position:absolute; width:100%; height:10px; background:#00FFFF; border:1px solid #000; box-sizing:border-box; cursor:pointer; }
.note.long{ background:#0FA; }
.note.selected{ outline:2px solid #FFD700; }

/* ====== 出力JSON ====== */
textarea { width:100%; height:220px; background:#000; color:#0f0; border:2px solid #333; margin-top:4px; padding:6px; font-family:monospace; font-size:12px; box-sizing:border-box; }
</style>
</head>

<body>

<header>
<input type="file" id="audioUpload" accept="audio/*">
BPM <input id="bpm" type="number" value="120">
Speed <input id="speed" type="number" value="2.6" step="0.1">
Snap <select id="snap">
<option value="1">1/4</option>
<option value="0.5">1/8</option>
<option value="0.25" selected>1/16</option>
<option value="0.125">1/32</option></select>
Diff <select id="diff"><option>easy</option><option selected>normal</option><option>hard</option></select>
Sustain(ms) <input id="sustain" type="number" value="0">
<button onclick="undo()">Undo</button>
<button onclick="playPause()">Play/Pause</button>
<button onclick="exportJSON()">Export</button>
</header>

<canvas id="wave"></canvas>
<div id="timeline"></div>
<div id="lanes"></div>
<textarea id="output"></textarea>

<audio id="song" preload="auto"></audio>

<script>
/* ====== STATE ====== */
const state={song:{bpm:120,speed:2.6},lanes:4,diffs:{easy:[],normal:[],hard:[]},editor:{snap:0.25,history:[]},generators:[],scrollY:0};

/* ====== UTILS ====== */
const bpm=document.getElementById("bpm");
const speed=document.getElementById("speed");
const snap=document.getElementById("snap");
const diff=document.getElementById("diff");
const sustain=document.getElementById("sustain");
const lanesDiv=document.getElementById("lanes");
const output=document.getElementById("output");
const wave=document.getElementById("wave");
const ctx=wave.getContext("2d");
const song=document.getElementById("song");

const beatMs=()=>60000/state.song.bpm;
const beatToMs=b=>Math.floor(b*beatMs());
const msToBeat=m=>m/beatMs();

function saveHistory(){state.editor.history.push(JSON.stringify(state.diffs));}
function undo(){if(state.editor.history.length){state.diffs=JSON.parse(state.editor.history.pop()); render();}}

/* ====== NOTES ====== */
function addNote(time,lane,sus=0){saveHistory(); state.diffs[curDiff()].push([time,lane,sus]); render();}
function removeNote(i){saveHistory(); state.diffs[curDiff()].splice(i,1); render();}
function curDiff(){return diff.value;}
function getNotesInRange(startBeat,endBeat){
  let result=[];
  state.diffs[curDiff()].forEach(n=>{const b=msToBeat(n[0]);if(b>=startBeat&&b<=endBeat)result.push(n);});
  state.generators.forEach(g=>{for(let b=g.startBeat;b<=endBeat;b+=g.snap){if(b<startBeat)continue; g.func(b).forEach(n=>result.push([n.time,n.lane,n.sustain]));}});
  return result;
}

/* ====== SETUP LANES ====== */
function setupLanes(){
  lanesDiv.style.gridTemplateColumns=`repeat(${state.lanes},1fr)`;
  lanesDiv.innerHTML="";
  for(let i=0;i<state.lanes;i++){
    const l=document.createElement("div");
    l.className="lane";
    l.addEventListener("click",(e)=>place(i,e));
    lanesDiv.appendChild(l);
  }
}
setupLanes();

/* ====== PLACE NOTE ====== */
function place(lane,e){
  const rect=lanesDiv.children[lane].getBoundingClientRect();
  const y = e.clientY - rect.top + state.scrollY;
  let beat = y/20; // scale
  beat = Math.round(beat/state.editor.snap)*state.editor.snap;
  const sus = +sustain.value;
  addNote(beatToMs(beat),lane,sus);
}

/* ====== RENDER ====== */
function render(){
  setupLanes();
  const scrollY=state.scrollY;
  state.diffs[curDiff()].forEach((n,i)=>{
    const el=document.createElement("div");
    el.className="note"+(n[2]>0?" long":"");
    el.style.bottom=(msToBeat(n[0])*20 - scrollY)+"px";
    el.style.height=(n[2]>0?(n[2]/20):10)+"px";
    el.onclick=e=>{e.stopPropagation(); removeNote(i)};
    lanesDiv.children[n[1]].appendChild(el);
  });
  drawWaveDisplay();
}

/* ====== WAVEFORM ====== */
let waveData=[];
function drawWaveDisplay(){
  ctx.clearRect(0,0,wave.width,wave.height);
  ctx.fillStyle="#444";
  for(let i=0;i<waveData.length;i++){
    const x=i*wave.width/waveData.length;
    const y=wave.height/2 - waveData[i]*wave.height/2;
    ctx.fillRect(x,wave.height/2,1,-y);
  }
}

/* ====== AUDIO UPLOAD ====== */
document.getElementById("audioUpload").addEventListener("change",(e)=>{
  const file = e.target.files[0];
  if(!file) return;
  song.src=URL.createObjectURL(file);
  song.load();
  generateWaveform(file);
});

/* ====== GENERATE WAVEFORM ====== */
async function generateWaveform(file){
  const reader=new FileReader();
  reader.onload=async (ev)=>{
    const arrayBuffer=ev.target.result;
    const audioCtx=new AudioContext();
    const buffer=await audioCtx.decodeAudioData(arrayBuffer);
    waveData=buffer.getChannelData(0); render();
  }
  reader.readAsArrayBuffer(file);
}

/* ====== PLAY/PAUSE ====== */
function playPause(){
  if(song.paused) song.play();
  else song.pause();
  requestAnimationFrame(updateScroll);
}

/* ====== SCROLL SYNC ====== */
function updateScroll(){
  state.scrollY = msToBeat(song.currentTime*1000)*20 - lanesDiv.clientHeight/2;
  render();
  if(!song.paused) requestAnimationFrame(updateScroll);
}

/* ====== EXPORT JSON ====== */
function exportJSON(){
  const notes=getNotesInRange(0, Infinity);
  const json={song:{bpm:+bpm.value,speed:+speed.value,audioFile:audioUpload.files[0]?.name||"unknown"},notes};
  output.value=JSON.stringify(json,null,2);
}

/* ====== AUTO GEN EXAMPLE ====== */
state.generators.push({
  startBeat:0,endBeat:Infinity,snap:0.5,
  func:(beat)=>[{time:beatToMs(beat),lane:Math.floor(beat)%state.lanes,sustain:0}]
});
</script>

</body>
</html>
